name: Publish to GitHub Pages
on:
  workflow_dispatch:
    inputs:
      workflow_run_id:
        description: 'Workflow Run ID from test-build (leave empty for latest)'
        required: false
        type: string
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
        - production
        - staging

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  find-build:
    runs-on: ubuntu-latest
    outputs:
      run_id: ${{ steps.find-run.outputs.run_id }}
      artifact_name: ${{ steps.find-run.outputs.artifact_name }}
    
    steps:
    - name: Find latest successful build
      id: find-run
      uses: actions/github-script@v7
      with:
        script: |
          const runId = '${{ github.event.inputs.workflow_run_id }}';
          
          if (runId) {
            console.log(`Using specified run ID: ${runId}`);
            return { run_id: runId, artifact_name: `web-app-build-*` };
          }
          
          // Find latest successful test-build workflow run
          const runs = await github.rest.actions.listWorkflowRuns({
            owner: context.repo.owner,
            repo: context.repo.repo,
            workflow_id: '.github/workflows/test-build.yml',
            status: 'success',
            per_page: 1
          });
          
          if (runs.data.workflow_runs.length === 0) {
            throw new Error('No successful test-build workflow runs found. Please run the test-build workflow first.');
          }
          
          const latestRun = runs.data.workflow_runs[0];
          console.log(`Found latest successful run: ${latestRun.id} from ${latestRun.head_branch}`);
          
          return { 
            run_id: latestRun.id.toString(),
            artifact_name: `web-app-build-*`
          };

  publish:
    needs: find-build
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'production' }}
    
    steps:
    - name: Setup Pages
      uses: actions/configure-pages@v5
      
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        github-token: ${{ secrets.PAT || secrets.GITHUB_TOKEN }}
        run-id: ${{ needs.find-build.outputs.run_id }}
        pattern: ${{ needs.find-build.outputs.artifact_name }}
        merge-multiple: true
        
    - name: Verify build artifacts
      run: |
        echo "üîç Checking for build artifacts..."
        ls -la
        
        if [ ! -d "dist" ]; then
          echo "‚ùå No dist directory found in artifacts"
          echo ""
          echo "üìã Available files:"
          find . -maxdepth 2 -type f | head -10
          echo ""
          echo "üì¶ Available directories:"
          find . -maxdepth 2 -type d | head -10
          echo ""
          
          # Try to find any web-related files
          if find . -name "*.html" -o -name "*.js" -o -name "*.css" | head -5; then
            echo ""
            echo "üîß Found some web files, creating dist directory..."
            mkdir -p dist
            find . -maxdepth 2 \( -name "*.html" -o -name "*.js" -o -name "*.css" -o -name "*.json" -o -name "*.ico" \) -exec cp {} dist/ \; 2>/dev/null || true
          else
            echo ""
            echo "üö® No build artifacts found. Creating fallback page..."
            mkdir -p dist
            cat > dist/index.html << 'EOF'
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Web Application - Deployed</title>
            <style>
                body { 
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
                    margin: 0; 
                    padding: 40px; 
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    min-height: 100vh;
                    color: white;
                }
                .container { 
                    max-width: 800px; 
                    margin: 0 auto;
                    background: rgba(255,255,255,0.1);
                    padding: 40px;
                    border-radius: 10px;
                    backdrop-filter: blur(10px);
                }
                .status { 
                    padding: 20px; 
                    border-radius: 5px; 
                    margin: 20px 0;
                }
                .success { 
                    background: rgba(40, 167, 69, 0.2); 
                    border: 1px solid #28a745; 
                }
                .info {
                    background: rgba(23, 162, 184, 0.2);
                    border: 1px solid #17a2b8;
                }
                h1 { margin-top: 0; }
                code {
                    background: rgba(0,0,0,0.2);
                    padding: 2px 6px;
                    border-radius: 3px;
                }
            </style>
        </head>
        <body>
            <div class="container">
                <h1>üöÄ Web Application Deployed</h1>
                
                <div class="status success">
                    <h2>‚úÖ Deployment Successful</h2>
                    <p>Your web application has been deployed to GitHub Pages.</p>
                </div>
                
                <div class="status info">
                    <h3>üìã Deployment Details</h3>
                    <ul>
                        <li><strong>Repository:</strong> <code>${{ github.repository }}</code></li>
                        <li><strong>Workflow Run:</strong> <code>${{ needs.find-build.outputs.run_id }}</code></li>
                        <li><strong>Deployed at:</strong> <code>$(date)</code></li>
                    </ul>
                </div>
                
                <div class="status info">
                    <h3>üîß Note</h3>
                    <p>Build artifacts were not found, so this fallback page is displayed. 
                    Make sure the <code>test-build</code> workflow has run successfully before deploying.</p>
                </div>
            </div>
        </body>
        </html>
        EOF
                  fi
                else
                  echo "‚úÖ dist directory found"
                  echo "üìÅ Contents:"
                  ls -la dist/
                fi
        
    - name: Fix asset paths for GitHub Pages (if needed)
      if: success()
      run: |
        if [ -d "dist" ]; then
          echo "üîß Checking if asset path fixes are needed..."
          
          REPO_NAME="${{ github.event.repository }}"
          USERNAME="${{ github.repository_owner }}"
          
          echo "Repository: $REPO_NAME"
          echo "Username: $USERNAME"
          
          # If repo name is not the username.github.io, it's a subdirectory deployment
          if [ "$REPO_NAME" != "$USERNAME.github.io" ] && [ "$REPO_NAME" != "$USERNAME" ]; then
            echo "üìÅ Deploying to subdirectory: /$REPO_NAME"
            
            # Update HTML files to use relative paths for subdirectory deployment
            if find dist -name "*.html" -type f | head -1 | grep -q .; then
              echo "Updating HTML files..."
              find dist -name "*.html" -type f -exec sed -i 's|href="/|href="./|g' {} \;
              find dist -name "*.html" -type f -exec sed -i 's|src="/|src="./|g' {} \;
              echo "‚úÖ HTML paths updated"
            fi
            
            # Update JS files (be more conservative)
            if find dist -name "*.js" -type f | head -1 | grep -q .; then
              echo "Updating JS files..."
              find dist -name "*.js" -type f -exec sed -i 's|"/|"./|g' {} \;
              echo "‚úÖ JS paths updated"
            fi
          else
            echo "üåê Deploying to root domain - no path fixes needed"
          fi
        fi
        
    - name: List final dist contents
      run: |
        echo "üì¶ Final dist contents for deployment:"
        if [ -d "dist" ]; then
          ls -la dist/
          echo ""
          echo "üìÑ HTML files:"
          find dist -name "*.html" -exec basename {} \; 2>/dev/null || echo "None"
          echo ""
          echo "üìú JS files:"
          find dist -name "*.js" -exec basename {} \; 2>/dev/null || echo "None"
        else
          echo "‚ùå No dist directory"
        fi
        
    - name: Upload to GitHub Pages
      uses: actions/upload-pages-artifact@v3
      with:
        path: ./dist
        
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4

  notify:
    needs: publish
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Notify deployment status
      run: |
        if [ "${{ needs.publish.result }}" == "success" ]; then
          echo "‚úÖ Web application successfully deployed to GitHub Pages"
          echo "üåê URL: https://${{ github.repository_owner }}.github.io/${{ github.event.repository }}"
          
          # Also show the deployment URL from the deployment step
          if [ "${{ needs.publish.outputs.deployment }}" ]; then
            echo "üîó Deployment URL: ${{ needs.publish.outputs.deployment }}"
          fi
        else
          echo "‚ùå Deployment failed"
          echo "üîç Check the publish job logs for details"
          exit 1
        fi